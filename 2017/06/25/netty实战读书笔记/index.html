<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>《Netty实战》读书笔记 - emacsist</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="emacsist" />
  <meta name="description" content="Netty 核心组件 Channel : 传入或传出数据的载体 回调 : 一个被提供给另一个方法的方法引用 Future : 提供了另一种在完成时通知应用程序的方式. Netty 的出站I/O 操作都将返" />

  <meta name="keywords" content="Golang, Java, PostgreSQL, Postgres, MySQL, emacsist, RabbitMQ, Go, emacs, orgmode" />






<meta name="generator" content="Hugo 0.54.0" />


<link rel="canonical" href="https://emacsist.github.io/2017/06/25/netty%E5%AE%9E%E6%88%98%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" />

<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">




<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>


<link href="/dist/even.min.css?v=3.1.1" rel="stylesheet">





<meta property="og:title" content="《Netty实战》读书笔记" />
<meta property="og:description" content="Netty 核心组件 Channel : 传入或传出数据的载体 回调 : 一个被提供给另一个方法的方法引用 Future : 提供了另一种在完成时通知应用程序的方式. Netty 的出站I/O 操作都将返" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://emacsist.github.io/2017/06/25/netty%E5%AE%9E%E6%88%98%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" />
<meta property="article:published_time" content="2017-06-25T12:30:34&#43;00:00"/>
<meta property="article:modified_time" content="2017-06-25T12:30:34&#43;00:00"/>

<meta itemprop="name" content="《Netty实战》读书笔记">
<meta itemprop="description" content="Netty 核心组件 Channel : 传入或传出数据的载体 回调 : 一个被提供给另一个方法的方法引用 Future : 提供了另一种在完成时通知应用程序的方式. Netty 的出站I/O 操作都将返">


<meta itemprop="datePublished" content="2017-06-25T12:30:34&#43;00:00" />
<meta itemprop="dateModified" content="2017-06-25T12:30:34&#43;00:00" />
<meta itemprop="wordCount" content="3317">



<meta itemprop="keywords" content="netty,java," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="《Netty实战》读书笔记"/>
<meta name="twitter:description" content="Netty 核心组件 Channel : 传入或传出数据的载体 回调 : 一个被提供给另一个方法的方法引用 Future : 提供了另一种在完成时通知应用程序的方式. Netty 的出站I/O 操作都将返"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">emacsist</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">emacsist</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">《Netty实战》读书笔记</h1>

      <div class="post-meta">
        <span class="post-time"> 2017-06-25 </span>
        
        <span class="more-meta"> 3317 words </span>
        <span class="more-meta"> 7 mins read </span>
        <span id="busuanzi_container_page_pv" class="more-meta"> <span id="busuanzi_value_page_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> times read </span>
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  
  <div class="post-toc-content">
    <nav id="TableOfContents">
<ul>
<li><a href="#netty-核心组件">Netty 核心组件</a>
<ul>
<li><a href="#关于-channelpipeline-的正确理解">关于 ChannelPipeline 的正确理解</a></li>
</ul></li>
<li><a href="#echo-服务器">echo 服务器</a>
<ul>
<li><a href="#server-端代码">server 端代码</a>
<ul>
<li><a href="#handler">Handler</a></li>
<li><a href="#bootstrap-代码">Bootstrap 代码</a></li>
</ul></li>
<li><a href="#client-端代码">client 端代码</a>
<ul>
<li><a href="#handler-代码">Handler 代码</a></li>
<li><a href="#bootstrap-代码-1">Bootstrap 代码</a></li>
</ul></li>
<li><a href="#运行及结果">运行及结果</a>
<ul>
<li><a href="#server">server</a></li>
<li><a href="#client">client</a></li>
</ul></li>
</ul></li>
<li><a href="#netty-网络抽象">Netty 网络抽象</a></li>
<li><a href="#netty-两种发送消息方式">Netty 两种发送消息方式</a></li>
<li><a href="#编码器与解码器">编码器与解码器</a></li>
<li><a href="#内置的传输">内置的传输</a></li>
<li><a href="#bytebuf-netty的数据容器">ByteBuf —— Netty的数据容器</a>
<ul>
<li><a href="#使用模式">使用模式</a></li>
<li><a href="#派生缓冲区">派生缓冲区</a></li>
</ul></li>
<li><a href="#bytebufholder-接口">ByteBufHolder 接口</a></li>
<li><a href="#channel-的生命周期">Channel 的生命周期</a></li>
<li><a href="#channelhandler-的生命周期">ChannelHandler 的生命周期</a></li>
<li><a href="#资源管理">资源管理</a></li>
<li><a href="#异常处理">异常处理</a></li>
<li><a href="#jdk-5-线程模型">JDK 5 线程模型</a></li>
<li><a href="#eventloop-接口">EventLoop 接口</a></li>
<li><a href="#netty-4-中的-i-o-和事件处理">Netty 4 中的 I/O 和事件处理</a></li>
<li><a href="#netty-3-中的-i-o-操作">Netty 3 中的 I/O 操作</a></li>
<li><a href="#线程管理">线程管理</a></li>
<li><a href="#eventloop-的线程分配">EventLoop 的线程分配</a>
<ul>
<li><a href="#nio-中">NIO 中</a></li>
<li><a href="#oio-中">OIO 中</a></li>
</ul></li>
<li><a href="#导引">导引</a>
<ul>
<li><a href="#bootstrap">Bootstrap</a></li>
</ul></li>
<li><a href="#内置编-解码器">内置编/解码器</a></li>
</ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      

<h1 id="netty-核心组件">Netty 核心组件</h1>

<ul>
<li>Channel : 传入或传出数据的载体</li>
<li>回调 : 一个被提供给另一个方法的方法引用</li>
<li>Future : 提供了另一种在完成时通知应用程序的方式. Netty 的出站I/O 操作都将返回一个 ChannelFuture.</li>
<li>事件 和  ChannelHandler : Netty 使用不同的事件来通知我们状态的改变或者是操作的状态。</li>
<li>EeventLoop : Netty 在内部会为每个 Channel 分配一个 EventLoop，用以处理所有事件</li>
</ul>

<pre><code class="language-bash">入站事件 -&gt; 入站处理器 -&gt; 入站事件 -&gt; 入站处理器 -&gt; ...

... &lt;- 出站处理器 &lt;- 出站事件 &lt;- 出站处理器 &lt;- 出站事件
</code></pre>

<h2 id="关于-channelpipeline-的正确理解">关于 ChannelPipeline 的正确理解</h2>

<p><a href="http://netty.io/4.0/api/io/netty/channel/ChannelPipeline.html">doc</a></p>

<p>其实官方文档已经给出了非常详细的解释了~</p>

<h1 id="echo-服务器">echo 服务器</h1>

<p>[github emacsist nett-echo]()</p>

<p>纯手工输入~自己输入一次，加深下印象</p>

<h2 id="server-端代码">server 端代码</h2>

<h3 id="handler">Handler</h3>

<pre><code class="language-bash">package com.github.emacsist.echo.server;

import io.netty.buffer.ByteBuf;
import io.netty.buffer.Unpooled;
import io.netty.channel.ChannelFutureListener;
import io.netty.channel.ChannelHandler;
import io.netty.channel.ChannelHandlerContext;
import io.netty.channel.ChannelInboundHandlerAdapter;
import io.netty.util.CharsetUtil;

/**
 * Created by emacsist on 2017/6/25.
 */
@ChannelHandler.Sharable
public class EchoServerHandler extends ChannelInboundHandlerAdapter {
    @Override
    public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception {
        ByteBuf in = (ByteBuf)msg;
        System.out.println(&quot;Server received: &quot; + in.toString(CharsetUtil.UTF_8));
        ctx.write(in);
    }

    @Override
    public void channelReadComplete(ChannelHandlerContext ctx) throws Exception {
        ctx.writeAndFlush(Unpooled.EMPTY_BUFFER).addListener(ChannelFutureListener.CLOSE);
    }

    @Override
    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws Exception {
        cause.printStackTrace();
        ctx.close();
    }
}

</code></pre>

<h3 id="bootstrap-代码">Bootstrap 代码</h3>

<pre><code class="language-bash">package com.github.emacsist.echo.server;

import io.netty.bootstrap.ServerBootstrap;
import io.netty.channel.ChannelFuture;
import io.netty.channel.ChannelInitializer;
import io.netty.channel.EventLoopGroup;
import io.netty.channel.nio.NioEventLoopGroup;
import io.netty.channel.socket.SocketChannel;
import io.netty.channel.socket.nio.NioServerSocketChannel;

import java.net.InetSocketAddress;

/**
 * Created by emacsist on 2017/6/25.
 */
public class EchoServer {
    private final int port;

    public EchoServer(int port) {
        this.port = port;
    }

    public void start() throws InterruptedException {
        final EchoServerHandler serverHandler = new EchoServerHandler();
        EventLoopGroup eventLoopGroup = new NioEventLoopGroup();
        try {
            ServerBootstrap b = new ServerBootstrap();
            b.group(eventLoopGroup).channel(NioServerSocketChannel.class).localAddress(new InetSocketAddress(port))
                    .childHandler(new ChannelInitializer&lt;SocketChannel&gt;() {

                        protected void initChannel(SocketChannel socketChannel) throws Exception {
                            socketChannel.pipeline().addLast(serverHandler);
                        }
                    });
            ChannelFuture f = b.bind().sync();
            f.channel().closeFuture().sync();
        } finally {
            eventLoopGroup.shutdownGracefully().sync();
        }
    }

    public static void main(String[] args) throws InterruptedException {
        if (args.length != 1 ){
            System.err.println(&quot;Usage: &quot; + EchoServer.class.getSimpleName() + &quot; &lt;port&gt;&quot;);
            return;
        }
        int port = Integer.parseInt(args[0]);
        new EchoServer(port).start();
    }
}

</code></pre>

<h2 id="client-端代码">client 端代码</h2>

<h3 id="handler-代码">Handler 代码</h3>

<pre><code class="language-bash">package com.github.emacsist.echo.client;

import io.netty.buffer.ByteBuf;
import io.netty.buffer.Unpooled;
import io.netty.channel.ChannelHandler;
import io.netty.channel.ChannelHandlerContext;
import io.netty.channel.SimpleChannelInboundHandler;
import io.netty.util.CharsetUtil;

/**
 * Created by emacsist on 2017/6/25.
 */
@ChannelHandler.Sharable
public class EchoClientHandler extends SimpleChannelInboundHandler&lt;ByteBuf&gt; {
    @Override
    public void channelActive(ChannelHandlerContext ctx) throws Exception {
        ctx.writeAndFlush(Unpooled.copiedBuffer(&quot;Netty rocks!&quot;, CharsetUtil.UTF_8));
    }

    protected void channelRead0(ChannelHandlerContext channelHandlerContext, ByteBuf byteBuf) throws Exception {
        System.out.println(&quot;Client received: &quot; + byteBuf.toString(CharsetUtil.UTF_8));
    }

    @Override
    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws Exception {
        cause.printStackTrace();
        ctx.close();
    }
}

</code></pre>

<h3 id="bootstrap-代码-1">Bootstrap 代码</h3>

<pre><code class="language-bash">package com.github.emacsist.echo.client;

import io.netty.bootstrap.Bootstrap;
import io.netty.channel.ChannelFuture;
import io.netty.channel.ChannelInitializer;
import io.netty.channel.EventLoopGroup;
import io.netty.channel.nio.NioEventLoopGroup;
import io.netty.channel.socket.SocketChannel;
import io.netty.channel.socket.nio.NioSocketChannel;

import java.net.InetSocketAddress;


/**
 * Created by emacsist on 2017/6/25.
 */
public class EchoClient {
    private final String host;
    private final int port;
    public EchoClient(String host, int port){
        this.host = host;
        this.port = port;
    }

    public void start() throws InterruptedException {
        EventLoopGroup group = new NioEventLoopGroup();
        try{
            Bootstrap b = new Bootstrap();
            b.group(group).channel(NioSocketChannel.class).remoteAddress(new InetSocketAddress(host, port))
                    .handler(new ChannelInitializer&lt;SocketChannel&gt;() {

                        protected void initChannel(SocketChannel socketChannel) throws Exception {
                            socketChannel.pipeline().addLast(new EchoClientHandler());
                        }
                    });
            ChannelFuture f = b.connect().sync();
            f.channel().closeFuture().sync();
        } finally {
            group.shutdownGracefully().sync();
        }
    }

    public static void main(String[] args) throws InterruptedException {
        if (args.length != 2 ){
            System.err.println(&quot;Usage: &quot; + EchoClient.class.getSimpleName() + &quot; &lt;host&gt; &lt;port&gt;&quot;);
            return;
        }
        String host = args[0];
        int port = Integer.parseInt(args[1]);
        new EchoClient(host, port).start();
    }
}
</code></pre>

<h2 id="运行及结果">运行及结果</h2>

<h3 id="server">server</h3>

<pre><code class="language-bash">[13:35:16] emacsist:echo-server $ mvn exec:java
[INFO] Scanning for projects...
[INFO]
[INFO] ------------------------------------------------------------------------
[INFO] Building echo-server 1.0-SNAPSHOT
[INFO] ------------------------------------------------------------------------
[INFO]
[INFO] &gt;&gt;&gt; exec-maven-plugin:1.2.1:java (default-cli) &gt; validate @ echo-server &gt;&gt;&gt;
[INFO]
[INFO] &lt;&lt;&lt; exec-maven-plugin:1.2.1:java (default-cli) &lt; validate @ echo-server &lt;&lt;&lt;
[INFO]
[INFO]
[INFO] --- exec-maven-plugin:1.2.1:java (default-cli) @ echo-server ---
Server received: Netty rocks!


</code></pre>

<h3 id="client">client</h3>

<pre><code class="language-bash">[13:35:05] emacsist:echo-client $ mvn exec:java
[INFO] Scanning for projects...
[INFO]
[INFO] ------------------------------------------------------------------------
[INFO] Building echo-client 1.0-SNAPSHOT
[INFO] ------------------------------------------------------------------------
[INFO]
[INFO] &gt;&gt;&gt; exec-maven-plugin:1.2.1:java (default-cli) &gt; validate @ echo-client &gt;&gt;&gt;
[INFO]
[INFO] &lt;&lt;&lt; exec-maven-plugin:1.2.1:java (default-cli) &lt; validate @ echo-client &lt;&lt;&lt;
[INFO]
[INFO]
[INFO] --- exec-maven-plugin:1.2.1:java (default-cli) @ echo-client ---
Client received: Netty rocks!
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 4.327 s
[INFO] Finished at: 2017-06-25T13:35:28+08:00
[INFO] Final Memory: 9M/155M
[INFO] ------------------------------------------------------------------------
[13:35:28] emacsist:echo-client $
</code></pre>

<h1 id="netty-网络抽象">Netty 网络抽象</h1>

<ul>
<li><p>Channel &ndash; Socket</p>

<ul>
<li>EmbeddedChannel</li>
<li>LocalServerChannel</li>
<li>NioDatagramChannel</li>
<li>NioSctpChannel</li>
<li>NioSocketChannel</li>
</ul></li>

<li><p>EventLoop &ndash; 控制流、多线程处理、并发。它是Netty的核心抽象，用于处理连接的生命周期中所发生的事件。</p>

<ul>
<li>一个 EventLoopGroup 包含一个或多个 EventLoop</li>
<li>一个 EventLoop 在它的生命周期内只和一个 Thread 绑定</li>
<li>所有由 EventLoop 处理的 I/O 事件都将在它专的 Thread 上被处理</li>
<li>一个 Channel 在它的生命周期内只注册一个 EventLoop</li>
<li>一个 EventLoop 可能会被分配给一个或多个 Channel</li>
</ul></li>

<li><p>ChannelFuture &ndash; 异步通知</p></li>

<li><p>ChannelHandler &ndash; 它充当了所有处理入站和出站数据的应用程序逻辑的容器。（ChannelInboundHandler 它处理入站的数据， ChannelOutboundHandler 它处理出站的数据）</p></li>

<li><p>ChannelPipeline &ndash; 提供了 ChannelHandler 链的容器。</p></li>

<li><p>ChannelHandlerContext &ndash; 当 ChannelHandler 被添加到 ChannelPipeline 时，它将会被分配一个 ChannelHandlerContext ，其代表了 ChannelHandler 和 ChannelPipeline 之间的绑定。虽然这个对象可以被用于获取其底层的 Channel，但是它主要还是被用于写出站数据。</p></li>
</ul>

<h1 id="netty-两种发送消息方式">Netty 两种发送消息方式</h1>

<ol>
<li>直接写到 Channel =&gt; 这导致消息从 ChannelPipeline 的 <em>尾端开始流动</em></li>
<li>写到和 ChannelHandler 相关联的 ChannelHandlerContext =&gt; 导致消息从 ChannelPipeline 中的下一个 ChannelHandler 开始流动</li>
</ol>

<h1 id="编码器与解码器">编码器与解码器</h1>

<p>Netty 接收或发送一个消息时，会发生一次数据转换</p>

<ul>
<li>入站：解码 byte -&gt; object</li>
<li>出站：编码 object -&gt; byte</li>
</ul>

<h1 id="内置的传输">内置的传输</h1>

<ul>
<li>NIO : 使用 java.nio.channels 包作为基础(支持的协议有 TCP, UDP, SCTP, UDT)</li>
<li>Epool : 使用 io.netty.channel.epoll ，由 JNI 驱动的 epoll() 和 非阻塞IO 。这个传输支持只有在Linux上可用的多种特性，如: SO_REUSEPORT，比NIO更快，而且是完全非阻塞的。（仅Linux，支持的协议有 TCP, UDP）</li>
<li>OIO : 使用 java.net 包作为基础，使用阻塞流（支持的协议有 TCP，UDP，SCTP， UDT）</li>
<li>Local : 使用 io.netty.channel.local ，可以在VM内部通过管道进行通信的本地传输</li>
<li>Embedded : 使用 io.netty.channel.embedded ，允许使用 ChannelHandler 而又不需要一个真正的基于网络的传输。这在测试你的 ChannelHandler 实现时非常有用。</li>
</ul>

<h1 id="bytebuf-netty的数据容器">ByteBuf —— Netty的数据容器</h1>

<p>它维护了两个不同的索引：一个用于读取，一个用于写入。</p>

<p>当你从 ByteBuf 读取时，它的 readerIndex 将会被递增(以 read 开头的API)已经被读取的字节数。同样地，当你写入 ByteBuf 时，它的 writerIndex 也会被递增（以 write 开头的API）。以 set, get 开头的API 不会改变这两个索引。</p>

<h2 id="使用模式">使用模式</h2>

<ul>
<li>堆缓冲区：这种模式称为 backing array，类似 JDK 的 ByteBuffer 的用法。它将数据存储在 JVM 的堆空间中。</li>
<li>直接缓冲区：它的数据存储在 JVM 的堆外空间，主要缺点是：它的分配和释放都比较昂贵。</li>
<li>复合缓冲区：它为多个 ByteBuf 提供了一个聚合视图（比如HTTP的头部+HTTP的Body）。（CompositeByteBuf，它可以同时包含直接内存分配和非直接内存分配的 ByteBuf）</li>
</ul>

<h2 id="派生缓冲区">派生缓冲区</h2>

<p>创建方法：</p>

<ul>
<li>duplicate()</li>
<li>slice()</li>
<li>slice(int, int)</li>
<li>Unpooled.unmodifiableBuffer()</li>
<li>order(ByteOrder)</li>
<li>readSlice(int)</li>
</ul>

<p>每个这些方法都将返回一个新的ByteBuf 实例，它具有自己的读索引，写索引和标记索引。 <em>其内部存储和JDK的ByteBuffer一样，也是共享</em> （注意，内容是共享的！！！）</p>

<h1 id="bytebufholder-接口">ByteBufHolder 接口</h1>

<p>除了实际的数据之外，还要存储各种属性值，如HTTP，字节的内容、状态码、cookie等。</p>

<ul>
<li>content() ： 返回这个 ByteBufHolder 所持有的 ByteBuf</li>
<li>copy() : 返回这个 ByteBufHolder 的一个深拷贝</li>
<li>duplicate() : 返回这个 ByteBufHolder 的一个浅拷贝</li>
</ul>

<h1 id="channel-的生命周期">Channel 的生命周期</h1>

<pre><code class="language-bash">ChannelRegistered -&gt; ChannelActive -&gt; ChannelInactive -&gt; ChannelUnregistered
</code></pre>

<h1 id="channelhandler-的生命周期">ChannelHandler 的生命周期</h1>

<pre><code class="language-bash">handlerAdded : 添加到 ChannelPipeline 中时被调用
handlerRemoved : 从 ChannelPipeline 中移除时被调用
handlerCaught : 当处理过程中在 ChannelPipeline 中有错误产生时调用
</code></pre>

<h1 id="资源管理">资源管理</h1>

<p>调用 <em>ChannelInboundHandler.channelRead()</em> 或者  <em>ChannelOutboundHandler.write()</em> 处理数据时，必须要保证没有任何的资源泄漏。（因为Netty是使用引用计数来处理池化的 ByteBuf 的）</p>

<p>为了检测资源泄漏的问题，Netty 提供了 class ResourceLeakDetector 来检测。</p>

<p>检测级别有:</p>

<ul>
<li>DISABLED : 禁用泄漏检测</li>
<li>SIMPLE : 使用 1% 的默认采样率检测并报告。（这是默认级别）</li>
<li>ADVANCED : 使用默认的采样率，报告所发现的任何的泄漏以及对应的消息被访问的位置</li>
<li>PARANOID : 类似 ADVANCED ，但是会对每一次（对消息的）访问都采样。（这应该只是在调试阶段使用）</li>
</ul>

<p>使用：</p>

<pre><code class="language-bash">java -Dio.netty.leakDetectionLevel=ADVANCED
</code></pre>

<h1 id="异常处理">异常处理</h1>

<ul>
<li>ChannelHandler.execeptionCaught() 默认实现是简单地将当前异常转发给 ChannelPipeline 中的下一个 ChannelHandler</li>
<li>如果异常到达了 ChannelPipeline 的尾端，它将会被记录为未被处理</li>
<li>要想定义自定义的处理逻辑，你需要重写 exceptionCaught() 方法。然后你需要决定是否需要将该异常传播出去</li>
</ul>

<h1 id="jdk-5-线程模型">JDK 5 线程模型</h1>

<p>池化，它的思想：</p>

<ol>
<li>从池中空闲线程列表中选择一个 Thread，并且派它去运行一个已经提交的任务（Runnable的实现）</li>
<li>当任务完成时，将该Thread返回给该列表，使其可被重用</li>
</ol>

<p>这虽然减少了每个任务线程的创建和销毁，但它并不能消除由 上下文切换 所带来的开销，随着线程数量的增加很快变得明显，并且在高负载下，愈演愈烈。</p>

<h1 id="eventloop-接口">EventLoop 接口</h1>

<pre><code class="language-bash">while(!terminated) {
         List&lt;Runnable&gt; readyEvents = blockUntilEventsReady()
         for (Runnable ev : readyEvents) {
                 ev.run()
         }
}
</code></pre>

<p>在这个线程模型中，一个 EventLoop 由一个永不变的 Thread 驱动。可根据可用核心不同，可能会创建多个 EventLoop 实例用以优化资源的使用，并且单个 EventLoop 可能会被指派用于服务多个 Channel</p>

<h1 id="netty-4-中的-i-o-和事件处理">Netty 4 中的 I/O 和事件处理</h1>

<p>在 Netty 4 中，所有的 I/O 操作和事件都已经被分配给了 EventLoop 的那个 Thread 来处理（注意，是处理，而不是触发哦）</p>

<h1 id="netty-3-中的-i-o-操作">Netty 3 中的 I/O 操作</h1>

<p>这个模型只保证了入站（上游）事件会在所谓的 I/O 线程（对应 Netty 4 中的 EventLoop ）执行。
所有的出站（下游）事件都由调用线程处理，其可能是 I/O 线程也可能是别的线程。</p>

<p>主要问题是：该模型不可能保证多个线程不会在同一时刻尝试访问出站事件。（例如，在不同的线程中调用 Channel.write() ，针对同一个 Channel 同时触发出站的事件，就会发生这种情况）</p>

<h1 id="线程管理">线程管理</h1>

<p>取决于当前执行的 Thread 的身份的确定(EventLoop的 inEvenLoop(Thread) 来确定) 。</p>

<p>如果是支撑的 EventLoop 的线程，那么所提交的代码将会被（直接）执行。
否则 EventLoop 将调度该任务以便稍后执行，并将它放入到内部队列中。</p>

<p>！！！！永远不要将一个长时间运行的任务放入到执行队列中，因为它将阻塞需要在同一线程上执行的任何的其他任务。</p>

<h1 id="eventloop-的线程分配">EventLoop 的线程分配</h1>

<h2 id="nio-中">NIO 中</h2>

<p>这种模型中，它们可能会被多个 Channel 所共享，这样可以通过尽可能少的 Thread 来支撑大量的 Channel ，而不是每个 Channel 分配一个 Thread 。EventLoopGroup 负责为每个新创建的 Channel 分配一个 EventLoop。在当前实现中，使用顺序循环（round-robin) 的方式进行分配以获取一个均衡的分布，并且相同的 EventLoop 可能会被分配给多个 Channel 。</p>

<h2 id="oio-中">OIO 中</h2>

<p>这里每个 Channel 都将被分配一个 EventLoop（以及它的Thread）</p>

<h1 id="导引">导引</h1>

<pre><code class="language-bash">                               &lt;-- Bootstrap（客户端）
Cloneable &lt;- AbstractBootstrap &lt;--
                               &lt;-- ServerBootstrap（服务器端）
</code></pre>

<p>为什么引导类是 Cloneable 的？</p>

<blockquote>
<p>你有时可能会需要创建多个具有类似配置或者完全相同配置的 Channel 。为了支持这种模式而又不需要为每个 Channel 都创建并配置一个新的引导类实例，AbstractBootstrap 被标记为了 Cloneable 。在一个已经配置完成的引导类实例上调用 clone() 方法将返回一个可以立即使用的引导类实例。</p>

<p>注意，这种方式只会创建引导类实例的 EventLoopGroup 的一个浅拷贝，所以，后者将在所有克隆的 Channel 实例之间共享。</p>
</blockquote>

<h2 id="bootstrap">Bootstrap</h2>

<h1 id="内置编-解码器">内置编/解码器</h1>

<pre><code class="language-bash">/Users/emacsist/.m2/repository/io/netty/netty-all/4.1.12.Final/netty-all-4.1.12.Final.jar!/io/netty/handler/codec
/Users/emacsist/.m2/repository/io/netty/netty-all/4.1.12.Final/netty-all-4.1.12.Final.jar!/io/netty/handler/codec/base64
/Users/emacsist/.m2/repository/io/netty/netty-all/4.1.12.Final/netty-all-4.1.12.Final.jar!/io/netty/handler/codec/bytes
/Users/emacsist/.m2/repository/io/netty/netty-all/4.1.12.Final/netty-all-4.1.12.Final.jar!/io/netty/handler/codec/compression
/Users/emacsist/.m2/repository/io/netty/netty-all/4.1.12.Final/netty-all-4.1.12.Final.jar!/io/netty/handler/codec/dns
/Users/emacsist/.m2/repository/io/netty/netty-all/4.1.12.Final/netty-all-4.1.12.Final.jar!/io/netty/handler/codec/haproxy
/Users/emacsist/.m2/repository/io/netty/netty-all/4.1.12.Final/netty-all-4.1.12.Final.jar!/io/netty/handler/codec/http
/Users/emacsist/.m2/repository/io/netty/netty-all/4.1.12.Final/netty-all-4.1.12.Final.jar!/io/netty/handler/codec/http/cookie
/Users/emacsist/.m2/repository/io/netty/netty-all/4.1.12.Final/netty-all-4.1.12.Final.jar!/io/netty/handler/codec/http/cors
/Users/emacsist/.m2/repository/io/netty/netty-all/4.1.12.Final/netty-all-4.1.12.Final.jar!/io/netty/handler/codec/http/multipart
/Users/emacsist/.m2/repository/io/netty/netty-all/4.1.12.Final/netty-all-4.1.12.Final.jar!/io/netty/handler/codec/http/websocketx
/Users/emacsist/.m2/repository/io/netty/netty-all/4.1.12.Final/netty-all-4.1.12.Final.jar!/io/netty/handler/codec/http/websocketx/extensions
/Users/emacsist/.m2/repository/io/netty/netty-all/4.1.12.Final/netty-all-4.1.12.Final.jar!/io/netty/handler/codec/http/websocketx/extensions/compression
/Users/emacsist/.m2/repository/io/netty/netty-all/4.1.12.Final/netty-all-4.1.12.Final.jar!/io/netty/handler/codec/http2
/Users/emacsist/.m2/repository/io/netty/netty-all/4.1.12.Final/netty-all-4.1.12.Final.jar!/io/netty/handler/codec/json
/Users/emacsist/.m2/repository/io/netty/netty-all/4.1.12.Final/netty-all-4.1.12.Final.jar!/io/netty/handler/codec/marshalling
/Users/emacsist/.m2/repository/io/netty/netty-all/4.1.12.Final/netty-all-4.1.12.Final.jar!/io/netty/handler/codec/memcache
/Users/emacsist/.m2/repository/io/netty/netty-all/4.1.12.Final/netty-all-4.1.12.Final.jar!/io/netty/handler/codec/memcache/binary
/Users/emacsist/.m2/repository/io/netty/netty-all/4.1.12.Final/netty-all-4.1.12.Final.jar!/io/netty/handler/codec/mqtt
/Users/emacsist/.m2/repository/io/netty/netty-all/4.1.12.Final/netty-all-4.1.12.Final.jar!/io/netty/handler/codec/protobuf
/Users/emacsist/.m2/repository/io/netty/netty-all/4.1.12.Final/netty-all-4.1.12.Final.jar!/io/netty/handler/codec/redis
/Users/emacsist/.m2/repository/io/netty/netty-all/4.1.12.Final/netty-all-4.1.12.Final.jar!/io/netty/handler/codec/rtsp
/Users/emacsist/.m2/repository/io/netty/netty-all/4.1.12.Final/netty-all-4.1.12.Final.jar!/io/netty/handler/codec/sctp
/Users/emacsist/.m2/repository/io/netty/netty-all/4.1.12.Final/netty-all-4.1.12.Final.jar!/io/netty/handler/codec/serialization
/Users/emacsist/.m2/repository/io/netty/netty-all/4.1.12.Final/netty-all-4.1.12.Final.jar!/io/netty/handler/codec/smtp
/Users/emacsist/.m2/repository/io/netty/netty-all/4.1.12.Final/netty-all-4.1.12.Final.jar!/io/netty/handler/codec/socks
/Users/emacsist/.m2/repository/io/netty/netty-all/4.1.12.Final/netty-all-4.1.12.Final.jar!/io/netty/handler/codec/socksx
/Users/emacsist/.m2/repository/io/netty/netty-all/4.1.12.Final/netty-all-4.1.12.Final.jar!/io/netty/handler/codec/socksx/v4
/Users/emacsist/.m2/repository/io/netty/netty-all/4.1.12.Final/netty-all-4.1.12.Final.jar!/io/netty/handler/codec/socksx/v5
/Users/emacsist/.m2/repository/io/netty/netty-all/4.1.12.Final/netty-all-4.1.12.Final.jar!/io/netty/handler/codec/spdy
/Users/emacsist/.m2/repository/io/netty/netty-all/4.1.12.Final/netty-all-4.1.12.Final.jar!/io/netty/handler/codec/stomp
/Users/emacsist/.m2/repository/io/netty/netty-all/4.1.12.Final/netty-all-4.1.12.Final.jar!/io/netty/handler/codec/string
/Users/emacsist/.m2/repository/io/netty/netty-all/4.1.12.Final/netty-all-4.1.12.Final.jar!/io/netty/handler/codec/xml
</code></pre>

    </div>

    
    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">emacsist</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">2017-06-25</span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">License</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>

    
    
<div class="post-reward">
  <input type="checkbox" name="reward" id="reward" hidden />
  <label class="reward-button" for="reward">Reward</label>
  <div class="qr-code">
    
    
      <label class="qr-code-image" for="reward">
        <img class="image" src="/img/wxpay.jpeg">
        <span>wechat</span>
      </label>
    
      <label class="qr-code-image" for="reward">
        <img class="image" src="/img/alipay.jpeg">
        <span>alipay</span>
      </label>
  </div>
</div>

    <footer class="post-footer">
      <div class="post-tags">
          
          <a href="/tags/netty/">netty</a>
          
          <a href="/tags/java/">java</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/2017/06/27/tomcat%E8%84%9A%E6%9C%AC-catalina.sh-%E6%B3%A8%E9%87%8A/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Tomcat脚本 catalina.sh 注释</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        
          <a class="next" href="/2017/06/23/i/o%E6%A8%A1%E5%9E%8B%E7%9F%A5%E8%AF%86%E6%94%B6%E9%9B%86%E6%95%B4%E7%90%86/">
            <span class="next-text nav-default">I/O模型知识收集整理</span>
            <span class="prev-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        
  <div id="comments-gitment"></div>
  <link rel="stylesheet" href="/lib/gitment/gitment-0.0.3.min.css">
    <script src="/lib/gitment/gitment-0.0.3.min.js"></script>
  <script type="text/javascript">
  const gitment = new Gitment({
    id: '2017-06-25 12:30:34 \x2b0000 UTC',
    title: '《Netty实战》读书笔记',
    link: decodeURI(location.href),
    desc: 'Netty 核心组件 Channel : 传入或传出数据的载体 回调 : 一个被提供给另一个方法的方法引用 Future : 提供了另一种在完成时通知应用程序的方式. Netty 的出站I\/O 操作都将返',
    owner: 'emacsist',
    repo: 'emacsist.github.io',
    oauth: {
      client_id: 'd1456501fba5329f3afa',
      client_secret: 'd1ecbb7929a49de947215701320c60b312a72d3a'
    }
  })
  gitment.render('comments-gitment')
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://github.com/imsun/gitment">comments powered by gitment.</a></noscript>

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:emacsist@qq.com" class="iconfont icon-email" title="email"></a>
      <a href="https://twitter.com/emacsist2016" class="iconfont icon-twitter" title="twitter"></a>
      <a href="https://plus.google.com/u/0/114200054463267049438" class="iconfont icon-google" title="google"></a>
      <a href="https://github.com/emacsist" class="iconfont icon-github" title="github"></a>
      <a href="https://www.zhihu.com/people/emacist" class="iconfont icon-zhihu" title="zhihu"></a>
      <a href="https://www.douban.com/people/emacsist/" class="iconfont icon-douban" title="douban"></a>
  <a href="https://emacsist.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv"> site pv: <span id="busuanzi_value_site_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> </span>
    <span class="division">|</span>
    <span id="busuanzi_container_site_uv"> site uv: <span id="busuanzi_value_site_uv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> </span>
  </div>


  <span class="copyright-year">
    &copy; 
    
      2014 - 
    2019
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">emacsist</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
<script src="/lib/highlight/highlight.pack.js?v=20171001"></script><script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  
<script type="text/javascript" src="/dist/even.min.js?v=3.1.1"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]},
      showProcessingMessages: false,
      messageStyle: 'none'
    };
  </script>
  <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-118327923-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>








<script src="https://s13.cnzz.com/z_stat.php?id=1273926342&web_id=1273926342"></script>

</body>
</html>
